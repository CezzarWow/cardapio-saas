const Utils = { formatCurrency: function (value) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value); }, formatMoneyInput: function (input, maxValue = 200) { let value = input.value.replace(/\D/g, ''); // Remove n√£o-n√∫meros if (value === '') { input.value = ''; return; } let numericValue = parseInt(value) / 100; if (numericValue > maxValue) { value = value.slice(0, -1); if (value === '') { input.value = ''; return; } numericValue = parseInt(value) / 100; } value = numericValue.toFixed(2); value = value.replace('.', ','); // Troca ponto por v√≠rgula value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.'); // Milhar input.value = 'R$ ' + value; }, formatPhone: function (input) { let value = input.value.replace(/\D/g, ''); if (value.length > 11) value = value.slice(0, 11); if (value.length > 10) { value = value.replace(/^(\d\d)(\d{5})(\d{4}).*/, '($1) $2-$3'); } else if (value.length > 6) { value = value.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, '($1) $2-$3'); } else if (value.length > 2) { value = value.replace(/^(\d\d)(\d{0,5}).*/, '($1) $2'); } input.value = value; }, initIcons: function () { if (typeof lucide !== 'undefined') { lucide.createIcons(); } } }; window.Utils = Utils; window.formatCurrency = Utils.formatCurrency; (function () { const isSamsung = /SamsungBrowser/i.test(navigator.userAgent); if (isSamsung) { document.body.classList.add('samsung-browser'); document.addEventListener('DOMContentLoaded', function () { const spacers = document.querySelectorAll('.modal-scroll-spacer'); spacers.forEach(function (spacer) { const modal = spacer.closest('.cardapio-modal-content'); if (!modal) return; const fixedBtn = modal.querySelector('.cardapio-floating-cart-btn, .send-order-btn'); const btnHeight = fixedBtn ? fixedBtn.offsetHeight : 70; spacer.style.height = (btnHeight + 60) + 'px'; }); }); } })(); const CartState = { items: [], add: function (options) { const item = this._createItem(options); this.items.push(item); return item; }, remove: function (itemId) { this.items = this.items.filter(item => item.id !== itemId); }, clear: function () { this.items = []; // Reseta o array }, getTotals: function () { return { count: this.items.reduce((sum, item) => sum + item.quantity, 0), value: this.items.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0) }; }, getItems: function () { return this.items; }, setItems: function (newItems) { this.items = newItems; }, _createItem: function (options) { return { id: Date.now() + Math.random(), productId: options.productId || options.id, name: options.name, basePrice: options.price, quantity: options.quantity || 1, additionals: options.additionals || [], observation: options.observation || '', unitPrice: options.price, isCombo: options.isCombo || false }; } }; window.CartState = CartState; const CartView = { update: function (totals, items) { this._updateTotals(totals); this._renderList(items); this._updateFloatingButton(totals); }, _updateTotals: function (totals) { const formattedValue = Utils.formatCurrency(totals.value); const elements = [ document.getElementById('cartTotal'), document.getElementById('cartModalTotal'), document.getElementById('suggestionsCartTotal') ]; elements.forEach(el => { if (el) el.textContent = formattedValue; }); }, _updateFloatingButton: function (totals) { const floatBtn = document.getElementById('floatingCart'); if (floatBtn) { floatBtn.classList.toggle('show', totals.count > 0); floatBtn.classList.add('pulse'); setTimeout(() => floatBtn.classList.remove('pulse'), 500); } }, _renderList: function (items) { const container = document.getElementById('cartItemsContainer'); if (!container) return; if (items.length === 0) { container.innerHTML = this._renderEmpty(); } else { container.innerHTML = items.map(item => this._renderItem(item)).join(''); } Utils.initIcons(); }, _renderEmpty: function () { return ` <div class="cardapio-cart-empty"> <div class="cardapio-cart-empty-icon"> <i data-lucide="shopping-bag" size="48"></i> </div> <p>Seu carrinho est√° vazio</p> </div> `; }, _renderItem: function (item) { const totalItem = item.unitPrice * item.quantity; let detailsHtml = ''; if (item.isCombo && item.products) { const subItems = item.products.map(p => { const extras = p.additionals?.length > 0 ? `<span style="font-size: 0.8rem; color: #888;">(+ ${p.additionals.map(a => a.name).join(', ')})</span>` : ''; return `<div><span>‚Ä¢ ${p.name}</span>${extras}</div>`; }).join(''); detailsHtml = ` <div class="cardapio-cart-combo-details" style="font-size: 0.85rem; color: #666; margin-top: 4px; padding-left: 8px; border-left: 2px solid #eee;"> ${subItems} </div>`; } const extrasHtml = !item.isCombo && item.additionals?.length > 0 ? `<p class="cardapio-cart-item-additionals">Extras: ${item.additionals.map(a => a.name).join(', ')}</p>` : ''; const obsHtml = item.observation ? `<p class="cardapio-cart-item-obs">Obs: ${item.observation}</p>` : ''; return ` <div class="cardapio-cart-item"> <div class="cardapio-cart-item-info"> <p class="cardapio-cart-item-name">${item.quantity}x ${item.name}</p> ${detailsHtml} ${extrasHtml} ${obsHtml} </div> <div class="cardapio-cart-item-actions"> <span class="cardapio-cart-item-price"> ${Utils.formatCurrency(totalItem)} </span> <button class="cardapio-cart-remove-icon-btn" onclick="CardapioCart.remove(${item.id})"> <i data-lucide="trash-2" size="18"></i> </button> </div> </div> `; }, pulseButton: function (selector) { const btn = document.querySelector(selector); if (btn) { btn.classList.add('btn-pulse'); setTimeout(() => btn.classList.remove('btn-pulse'), 300); } } }; window.CartView = CartView; const CardapioCart = { get items() { return CartState.items; }, set items(val) { CartState.setItems(val); }, add: function (options) { CartState.add(options); this.updateUI(); }, addDirect: function (id, name, price) { this.add({ id, name, price }); }, addDrink: function (id, name, price) { this.add({ id, name, price }); CartView.pulseButton(`.suggestion-drink-btn[data-id="${id}"]`); }, addSauce: function (id, name, price) { this.add({ productId: 'sauce_' + id, name: 'Molho: ' + name, price }); CartView.pulseButton(`.suggestion-sauce-btn[data-id="${id}"]`); }, addCombo: function (id, name, price) { this.add({ productId: 'combo_' + id, name, price, isCombo: true }); }, remove: function (itemId) { CartState.remove(itemId); this.updateUI(); }, clear: function () { CartState.clear(); this.updateUI(); }, getTotals: function () { return CartState.getTotals(); }, updateUI: function () { CartView.update(CartState.getTotals(), CartState.getItems()); } }; try { Object.defineProperty(window, 'cart', { get: () => CartState.items, set: (val) => CartState.setItems(val), configurable: true }); } catch (e) { window.cart = CartState.items; } window.addToCartDirect = (id, name, price, img) => CardapioCart.addDirect(id, name, price); window.addDrinkToCart = (id, name, price, img) => CardapioCart.addDrink(id, name, price); window.addSauceToCart = (id, name, price) => CardapioCart.addSauce(id, name, price); window.addComboToCart = (id, name, price, img) => CardapioCart.addCombo(id, name, price); window.removeFromCart = (id) => CardapioCart.remove(id); window.updateCartDisplay = () => CardapioCart.updateUI(); window.updateSuggestionsCartDisplay = () => CardapioCart.updateUI(); window.CardapioCart = CardapioCart; const CardapioModals = { init: function () { }, openSuggestions: function () { const modal = document.getElementById('suggestionsModal'); if (modal) { modal.classList.add('show'); Utils.initIcons(); } }, closeSuggestions: function () { document.getElementById('suggestionsModal').classList.remove('show'); }, openCart: function () { document.getElementById('cartModal').classList.add('show'); Utils.initIcons(); }, closeCart: function () { document.getElementById('cartModal').classList.remove('show'); }, goToCheckout: function () { this.closeCart(); this.openSuggestions(); CardapioCart.updateUI(); // Sincroniza visual } }; window.CardapioModals = CardapioModals; window.openProductModal = (id) => CardapioModals.openProduct(id); window.closeProductModal = () => CardapioModals.closeProduct(); window.increaseQuantity = () => CardapioModals.increaseQty(); window.decreaseQuantity = () => CardapioModals.decreaseQty(); window.openCartModal = () => CardapioModals.openCart(); window.closeCartModal = () => CardapioModals.closeCart(); window.openSuggestionsModal = () => CardapioModals.openSuggestions(); window.closeSuggestionsModal = () => CardapioModals.closeSuggestions(); window.goToCheckout = () => CardapioModals.goToCheckout(); document.addEventListener('change', function (e) { if (e.target.classList.contains('cardapio-additional-checkbox')) { const id = e.target.getAttribute('data-additional-id'); const name = e.target.getAttribute('data-additional-name'); const price = parseFloat(e.target.getAttribute('data-additional-price')); CardapioModals.toggleAdditional(id, name, price, e.target.checked); } }); window.addToCart = () => CardapioModals.addToCartAction(); (function () { 'use strict'; CardapioModals.currentProduct = null; CardapioModals.currentQuantity = 1; CardapioModals.selectedAdditionals = []; CardapioModals.basePrice = 0; CardapioModals._findProduct = function (productId) { if (typeof window.products !== 'undefined' && Array.isArray(window.products)) { const product = window.products.find(p => p.id == productId); if (product) return product; } console.warn('[CardapioModals] Produto n√£o encontrado no array. Tentando DOM. ID:', productId); const card = document.querySelector(`.cardapio-product-card[data-product-id="${productId}"]`); if (card) { return { id: productId, name: card.getAttribute('data-product-name'), price: parseFloat(card.getAttribute('data-product-price')), description: card.getAttribute('data-product-description'), image: card.getAttribute('data-product-image'), additionals: [] }; } console.error('[CardapioModals] Produto n√£o encontrado.', productId); return null; }; CardapioModals._getProductRelations = function (productId) { const relations = (typeof window.PRODUCT_RELATIONS !== 'undefined') ? window.PRODUCT_RELATIONS : {}; return relations[productId] || []; }; CardapioModals._fillProductInfo = function (product) { document.getElementById('modalProductName').textContent = product.name; document.getElementById('modalProductDescription').textContent = product.description || ''; document.getElementById('modalProductPrice').textContent = Utils.formatCurrency(this.basePrice); const imgEl = document.getElementById('modalProductImage'); if (product.image) { imgEl.src = (typeof BASE_URL !== 'undefined' ? BASE_URL : '') + '/uploads/' + product.image; imgEl.style.display = 'block'; } else { imgEl.style.display = 'none'; } }; CardapioModals._resetModalInputs = function () { const obsInput = document.getElementById('modalObservation'); if (obsInput) obsInput.value = ''; document.getElementById('modalQuantity').textContent = '1'; }; CardapioModals._showModal = function () { const modal = document.getElementById('productModal'); modal.classList.add('show'); requestAnimationFrame(() => { const content = modal.querySelector('.cardapio-modal-content'); const body = modal.querySelector('.cardapio-modal-body'); if (content) content.scrollTop = 0; if (body) body.scrollTop = 0; }); }; CardapioModals.openProduct = function (productId) { const product = this._findProduct(productId); if (!product) return; const relatedGroups = this._getProductRelations(product.id); const hasAdditionals = relatedGroups.length > 0; if (!hasAdditionals) { CardapioCart.addDirect(product.id, product.name, parseFloat(product.price), product.image); return; } this.currentProduct = product; this.currentQuantity = 1; this.selectedAdditionals = []; this.basePrice = parseFloat(product.price); this._fillProductInfo(product); this.renderAdditionals(relatedGroups); this._resetModalInputs(); this.updateModalPrice(); this._showModal(); }; CardapioModals.closeProduct = function () { document.getElementById('productModal').classList.remove('show'); this.currentProduct = null; }; CardapioModals.increaseQty = function () { this.currentQuantity++; this.updateQtyDisplay(); }; CardapioModals.decreaseQty = function () { if (this.currentQuantity > 1) { this.currentQuantity--; this.updateQtyDisplay(); } }; CardapioModals.updateQtyDisplay = function () { document.getElementById('modalQuantity').textContent = this.currentQuantity; this.updateModalPrice(); }; CardapioModals.renderAdditionals = function (groupIds) { this.selectedAdditionals = []; document.querySelectorAll('.cardapio-additional-checkbox').forEach(cb => cb.checked = false); const groups = document.querySelectorAll('.cardapio-additional-group'); const title = document.querySelector('.cardapio-modal-additionals-title'); if (!groupIds || !Array.isArray(groupIds) || groupIds.length === 0) { if (title) title.style.display = 'none'; groups.forEach(g => g.style.display = 'none'); return; } if (title) title.style.display = 'block'; const allowedGroupIds = new Set(groupIds.map(id => String(id))); let hasVisible = false; groups.forEach(group => { const isAllowed = allowedGroupIds.has(String(group.getAttribute('data-group-id'))); group.style.display = isAllowed ? 'block' : 'none'; if (isAllowed) hasVisible = true; }); if (!hasVisible && title) title.style.display = 'none'; }; CardapioModals.toggleAdditional = function (id, name, price, isChecked) { if (isChecked) { this.selectedAdditionals.push({ id, name, price }); } else { this.selectedAdditionals = this.selectedAdditionals.filter(a => a.id !== id); } this.updateModalPrice(); }; CardapioModals.updateModalPrice = function () { const addTotal = this.selectedAdditionals.reduce((sum, item) => sum + item.price, 0); const finalPrice = (this.basePrice + addTotal) * this.currentQuantity; document.getElementById('modalTotalPrice').textContent = Utils.formatCurrency(finalPrice); }; CardapioModals.addToCartAction = function () { if (!this.currentProduct) return; const observation = document.getElementById('modalObservation').value.trim(); const addTotal = this.selectedAdditionals.reduce((sum, a) => sum + a.price, 0); const item = { id: Date.now() + Math.random(), productId: this.currentProduct.id, name: this.currentProduct.name, basePrice: this.basePrice, quantity: this.currentQuantity, additionals: [...this.selectedAdditionals], observation: observation, unitPrice: this.basePrice + addTotal }; CardapioCart.add(item); this.closeProduct(); }; })(); const ComboValidator = { calculateTotal: function (basePrice, selections, quantity) { let extrasTotal = 0; Object.values(selections).forEach(list => { if (Array.isArray(list)) { list.forEach(item => { extrasTotal += (parseFloat(item.price) || 0); }); } }); return (basePrice + extrasTotal) * quantity; }, validate: function (combo, selections) { return true; }, prepareCartItem: function (combo, selections, quantity, observation) { const totalExtras = this.calculateTotal(0, selections, 1); // Extras unit√°rios const productsList = combo.items.map(item => { const extras = selections[item.product_id] || []; return { id: item.product_id, name: item.product_name, additionals: extras }; }); return { id: Date.now() + Math.random(), isCombo: true, comboId: combo.id, name: combo.name, image: combo.image, basePrice: parseFloat(combo.price), quantity: quantity, products: productsList, observation: observation || '', unitPrice: parseFloat(combo.price) + totalExtras }; } }; window.ComboValidator = ComboValidator; const ComboView = { renderModal: function (combo) { document.getElementById('modalComboName').textContent = combo.name; document.getElementById('modalComboDescription').textContent = combo.description || ''; document.getElementById('modalComboPrice').textContent = Utils.formatCurrency(parseFloat(combo.price)); const imgEl = document.getElementById('modalComboImage'); if (combo.image && imgEl) { imgEl.src = (typeof BASE_URL !== 'undefined' ? BASE_URL : '') + '/uploads/' + combo.image; imgEl.style.display = 'block'; } else if (imgEl) { imgEl.style.display = 'none'; } document.getElementById('modalComboQuantity').textContent = '1'; const obs = document.getElementById('modalComboObservation'); if (obs) obs.value = ''; this._ensureInstructionText(); this._renderProductList(combo.items); }, updatePrice: function (totalValue) { const el = document.getElementById('modalComboTotalPrice'); if (el) el.textContent = Utils.formatCurrency(totalValue); }, updateQuantity: function (qty) { const el = document.getElementById('modalComboQuantity'); if (el) el.textContent = qty; }, updateBadge: function (productId, count) { const badge = document.getElementById(`badge-${productId}`); if (badge) { badge.textContent = `${count} extra${count !== 1 ? 's' : ''}`; badge.style.display = count > 0 ? 'inline-block' : 'none'; } }, open: function () { document.getElementById('comboModal').classList.add('show'); Utils.initIcons(); }, close: function () { document.getElementById('comboModal').classList.remove('show'); }, _ensureInstructionText: function () { let instruction = document.getElementById('comboInstructionText'); if (!instruction) { instruction = document.createElement('p'); instruction.id = 'comboInstructionText'; instruction.style.cssText = 'text-align:left; margin-bottom:15px; margin-top:10px; font-weight:700; font-size:0.9rem; color:#e63946;'; instruction.textContent = 'Itens inclusos no combo. Clique para adicionar.'; const container = document.getElementById('comboProductsContainer'); if (container) container.parentNode.insertBefore(instruction, container); } }, _renderProductList: function (items) { const container = document.getElementById('comboProductsContainer'); if (!container) return; container.innerHTML = ''; if (!items || items.length === 0) { container.innerHTML = '<p style="color:#666; font-style:italic;">Nenhum item neste combo.</p>'; return; } items.forEach(item => { container.appendChild(this._createProductItemElement(item)); }); }, _createProductItemElement: function (item) { const fullProduct = (typeof products !== 'undefined') ? products.find(p => p.id == item.product_id) : null; const relations = (typeof PRODUCT_RELATIONS !== 'undefined') ? PRODUCT_RELATIONS : {}; const hasAdditionals = (item.allow_additionals == 1) && fullProduct && relations[fullProduct.id]?.length > 0; const wrapper = document.createElement('div'); wrapper.className = 'combo-product-collapse open'; const headerHtml = ` <div class="combo-product-header" ${hasAdditionals ? 'onclick="this.parentNode.classList.toggle(\'open\')"' : ''} style="${hasAdditionals ? 'cursor:pointer' : ''}"> <div class="combo-product-info"> <span>${item.product_name}</span> ${hasAdditionals ? `<span class="combo-extras-badge" id="badge-${item.product_id}" style="display:none">0 extras</span>` : ''} </div> ${hasAdditionals ? `<i data-lucide="chevron-down" class="combo-toggle-icon" size="16"></i>` : ''} </div>`; wrapper.innerHTML = headerHtml; if (hasAdditionals) { const body = document.createElement('div'); body.className = 'combo-product-body'; const list = document.createElement('div'); list.className = 'combo-additional-list'; [...new Set(relations[fullProduct.id])].forEach(groupId => { const original = document.querySelector(`.cardapio-additional-group[data-group-id="${groupId}"]`); if (original) { const clone = original.cloneNode(true); clone.style.display = 'block'; clone.querySelectorAll('input').forEach(input => this._setupInput(input, item, clone)); list.appendChild(clone); } }); body.appendChild(list); wrapper.appendChild(body); } return wrapper; }, _setupInput: function (input, item, container) { const { additionalId: addId, additionalName: name, additionalPrice: price } = input.dataset; const uniqueId = `combo-${item.product_id}-${addId}-${Date.now().toString(36)}`; Object.assign(input, { id: uniqueId, name: `combo_extras_${item.product_id}[]`, checked: false }); Object.assign(input.dataset, { comboProductId: item.product_id, comboAddId: addId, comboAddName: name, comboAddPrice: price }); input.classList.remove('cardapio-additional-checkbox'); const label = input.closest('label') || input.nextElementSibling || container.querySelector(`label[for="${input.id}"]`); if (label?.tagName === 'LABEL') label.setAttribute('for', uniqueId); } }; window.ComboView = ComboView; const ComboController = { currentCombo: null, quantity: 1, selections: {}, // { productId: [ {id, name, price} ] } init: function () { document.addEventListener('change', (e) => { if (e.target.matches('input[name^="combo_extras_"]')) { this.handleAdditionalChange(e.target); } }); }, open: function (comboId) { const combo = (typeof combos !== 'undefined') ? combos.find(c => c.id == comboId) : null; if (!combo) return console.error('Combo n√£o encontrado'); this.currentCombo = combo; this.quantity = 1; this.selections = {}; if (combo.items) { combo.items.forEach(item => this.selections[item.product_id] = []); } ComboView.renderModal(combo); this.updateTotal(); ComboView.open(); }, close: function () { ComboView.close(); this.currentCombo = null; }, handleAdditionalChange: function (input) { const productId = input.dataset.comboProductId; const addId = input.dataset.comboAddId; const name = input.dataset.comboAddName; const price = parseFloat(input.dataset.comboAddPrice); const isChecked = input.checked; if (!this.selections[productId]) this.selections[productId] = []; if (isChecked) { this.selections[productId].push({ id: addId, name, price }); } else { this.selections[productId] = this.selections[productId].filter(a => a.id != addId); } const count = this.selections[productId].length; ComboView.updateBadge(productId, count); this.updateTotal(); }, increaseQty: function () { this.quantity++; ComboView.updateQuantity(this.quantity); this.updateTotal(); }, decreaseQty: function () { if (this.quantity > 1) { this.quantity--; ComboView.updateQuantity(this.quantity); this.updateTotal(); } }, updateTotal: function () { if (!this.currentCombo) return; const total = ComboValidator.calculateTotal(parseFloat(this.currentCombo.price), this.selections, this.quantity); ComboView.updatePrice(total); }, addToCart: function () { if (!this.currentCombo) return; const obs = document.getElementById('modalComboObservation')?.value; const cartItem = ComboValidator.prepareCartItem(this.currentCombo, this.selections, this.quantity, obs); CardapioCart.add(cartItem); this.close(); } }; window.ComboController = ComboController; (function () { 'use strict'; if (typeof ComboController !== 'undefined') { ComboController.init(); } else { console.error('ComboController module not loaded!'); return; } CardapioModals.openCombo = (id) => ComboController.open(id); CardapioModals.closeCombo = () => ComboController.close(); CardapioModals.increaseComboQty = () => ComboController.increaseQty(); CardapioModals.decreaseComboQty = () => ComboController.decreaseQty(); CardapioModals.addComboToCart = () => ComboController.addToCart(); Object.defineProperty(CardapioModals, 'currentCombo', { get: () => ComboController.currentCombo }); })(); const CheckoutOrder = { send: async function (checkout) { const formData = this.captureFormData(); const validationError = this.validate(formData, checkout); if (validationError) { alert(validationError); return; } const orderData = this.prepareOrderData(formData, checkout); try { const result = await this.submitToApi(orderData); if (!result.success) { alert('Erro ao enviar pedido: ' + (result.message || 'Erro desconhecido')); return; } this.sendToWhatsApp(formData, checkout); checkout.reset(); } catch (error) { console.error('Erro ao enviar pedido:', error); alert('Erro de conex√£o ao enviar pedido. Por favor, tente novamente.'); } }, captureFormData: function () { return { name: document.getElementById('customerName')?.value.trim() || '', phone: document.getElementById('customerPhone')?.value.trim() || '', address: document.getElementById('customerAddress')?.value.trim() || '', number: document.getElementById('customerNumber')?.value.trim() || '', neighborhood: document.getElementById('customerNeighborhood')?.value.trim() || '', obs: document.getElementById('customerObs')?.value.trim() || '', changeAmount: document.getElementById('changeAmount')?.value.trim() || '' }; }, validate: function (formData, checkout) { if (!formData.name) { return 'Por favor, preencha seu nome.'; } if (checkout.selectedOrderType === 'entrega') { if (!formData.address) { return 'Por favor, preencha o endere√ßo.'; } if (!formData.number && !checkout.hasNoNumber) { return 'Por favor, preencha o n√∫mero ou selecione "Sem n¬∫".'; } } if (!checkout.selectedPaymentMethod) { return 'Por favor, selecione a forma de pagamento.'; } return null; // V√°lido }, prepareOrderData: function (formData, checkout) { const config = window.cardapioConfig || {}; const restaurantId = window.restaurantId || config.restaurant_id; const deliveryFee = checkout.getDeliveryFee(); return { restaurant_id: restaurantId, customer_name: formData.name, customer_phone: formData.phone, customer_address: formData.address, customer_number: formData.number, customer_neighborhood: formData.neighborhood, order_type: checkout.selectedOrderType, payment_method: checkout.selectedPaymentMethod, change_amount: formData.changeAmount, observation: formData.obs, delivery_fee: deliveryFee, items: CardapioCart.items.map(item => ({ product_id: item.productId || null, name: item.name, quantity: item.quantity, unit_price: item.unitPrice, observation: item.observation || '', additionals: (item.additionals || []).map(add => ({ id: add.id, name: add.name, price: add.price || 0 })) })) }; }, submitToApi: async function (orderData) { const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'); const response = await fetch(window.BASE_URL + '/api/order/create', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': csrfToken }, body: JSON.stringify(orderData) }); return await response.json(); }, sendToWhatsApp: function (formData, checkout) { const config = window.cardapioConfig || {}; const whatsappNumber = (config.whatsapp_number || '').replace(/\D/g, ''); let msgBefore = 'Ol√°! Gostaria de fazer um pedido:'; let msgAfter = 'Aguardo a confirma√ß√£o.'; try { if (config.whatsapp_message) { const parsed = JSON.parse(config.whatsapp_message); if (parsed && (typeof parsed === 'object') && (parsed.before || parsed.after)) { if (Array.isArray(parsed.before) && parsed.before.length > 0) { msgBefore = parsed.before.join('\n'); } if (Array.isArray(parsed.after) && parsed.after.length > 0) { msgAfter = parsed.after.join('\n'); } } else if (Array.isArray(parsed)) { if (parsed.length > 0 && parsed[0]) msgBefore = parsed[0]; if (parsed.length > 1 && parsed[1]) msgAfter = parsed[1]; } } } catch (e) { console.warn('Erro ao decodificar mensagens do WhatsApp', e); } const orderSummary = this.formatOrderSummary(formData, checkout); const finalMessage = `${msgBefore}\n\n${orderSummary}\n\n${msgAfter}`; if (whatsappNumber) { const url = `https://wa.me/55${whatsappNumber}?text=${encodeURIComponent(finalMessage)}`; window.open(url, '_blank'); alert('Pedido enviado com sucesso! ‚úÖ\n\nSeu pedido foi registrado e aparecer√° para o restaurante.'); } else { alert('Pedido registrado com sucesso! ‚úÖ\n\nO restaurante foi notificado.\n\n' + '(WhatsApp n√£o configurado para este restaurante)'); } }, formatOrderSummary: function (formData, checkout) { const deliveryFee = checkout.getDeliveryFee(); let summary = '*NOVO PEDIDO*\n\n' + 'üë§ *Nome:* ' + formData.name + '\n'; if (checkout.selectedOrderType === 'entrega') { summary += 'üìç *Entrega:* ' + formData.address + ', ' + formData.number + '\n' + 'üèòÔ∏è *Bairro:* ' + formData.neighborhood + '\n'; } else { const label = (checkout.selectedOrderType === 'local') ? 'Mesa/Comanda' : 'Retirada'; summary += 'üè™ *' + label + ':* ' + formData.number + '\n'; } summary += '\nüõí *ITENS:*\n'; CardapioCart.items.forEach(item => { summary += `‚Ä¢ ${item.quantity}x ${item.name} ` + (item.additionals.length ? `(${item.additionals.map(a => a.name).join(', ')})` : '') + '\n'; if (item.observation) summary += ` _Obs: ${item.observation}_\n`; }); if (checkout.selectedOrderType === 'entrega' && deliveryFee > 0) { summary += 'üõµ *Taxa de Entrega:* ' + Utils.formatCurrency(deliveryFee) + '\n'; } summary += '\nüí∞ *Total Final:* ' + Utils.formatCurrency(checkout.getFinalTotal()) + '\n'; summary += 'üí≥ *Pagamento:* ' + checkout.selectedPaymentMethod.toUpperCase(); if (checkout.selectedPaymentMethod === 'dinheiro' && formData.changeAmount) { summary += ' (Troco para: ' + formData.changeAmount + ')'; } if (formData.obs) { summary += '\nüìù *Obs Geral:* ' + formData.obs; } return summary; } }; window.CheckoutOrder = CheckoutOrder; const CheckoutFields = { toggleNoNumber: function (checkout) { const input = document.getElementById('customerNumber'); const btn = document.querySelector('.no-number-btn'); checkout.hasNoNumber = !checkout.hasNoNumber; if (checkout.hasNoNumber) { input.value = 'S/N'; input.disabled = true; btn.classList.add('active'); } else { input.value = ''; input.disabled = false; btn.classList.remove('active'); input.focus(); } }, toggleNoChange: function (checkout) { const input = document.getElementById('changeAmount'); const btn = document.querySelector('.no-change-btn'); checkout.hasNoChange = !checkout.hasNoChange; if (checkout.hasNoChange) { input.value = 'Sem troco'; input.disabled = true; btn.classList.add('active'); this.confirmChange(); } else { input.value = 'R$ 0,00'; input.disabled = false; btn.classList.remove('active'); } }, confirmChange: function () { const input = document.getElementById('changeAmount'); const inputGroup = document.getElementById('changeInputGroup'); const summary = document.getElementById('changeSummary'); const summaryText = document.getElementById('changeSummaryText'); let val = input.value; if (!val || val === 'R$ 0,00') val = 'Sem troco'; summaryText.textContent = (val === 'Sem troco') ? 'Sem troco' : 'Troco: ' + val; if (inputGroup) inputGroup.style.display = 'none'; if (summary) summary.style.display = 'flex'; document.getElementById('changeContainer').classList.add('summary-mode'); }, editChange: function (checkout) { const inputGroup = document.getElementById('changeInputGroup'); const summary = document.getElementById('changeSummary'); const input = document.getElementById('changeAmount'); if (inputGroup) inputGroup.style.display = 'block'; if (summary) summary.style.display = 'none'; document.getElementById('changeContainer').classList.remove('summary-mode'); if (input) { input.disabled = false; if (input.value && (input.value.includes('Sem') || input.value.includes('troco'))) { input.value = ''; } } document.querySelectorAll('.no-change-btn').forEach(btn => { btn.classList.remove('active'); }); checkout.hasNoChange = false; if (input) { setTimeout(() => input.focus(), 50); } }, scrollToChange: function () { const el = document.getElementById('changeContainer'); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, updateFieldsVisibility: function (type) { const msgLocal = document.getElementById('msgLocal'); const msgRetirada = document.getElementById('msgRetirada'); if (msgLocal) msgLocal.style.display = (type === 'local') ? 'block' : 'none'; if (msgRetirada) msgRetirada.style.display = (type === 'retirada') ? 'block' : 'none'; document.querySelectorAll('.delivery-only').forEach(el => { el.style.display = (type === 'entrega') ? '' : 'none'; }); const numberField = document.getElementById('numberFieldRow'); if (numberField) { numberField.style.display = (type === 'entrega') ? '' : 'none'; } const numInput = document.getElementById('customerNumber'); if (numInput) { numInput.placeholder = (type === 'local') ? 'Mesa *' : 'N¬∫ *'; } const numLabel = document.querySelector('label[for="customerNumber"]'); if (numLabel) { if (type === 'local') numLabel.textContent = 'Mesa / Comanda'; else if (type === 'retirada') numLabel.textContent = 'Identifica√ß√£o (Nome/ID)'; else numLabel.textContent = 'N√∫mero'; } } }; window.CheckoutFields = CheckoutFields; const CheckoutModals = { openOrderReview: function (checkout) { if (CardapioCart.items.length === 0) { alert('Seu carrinho est√° vazio!'); return; } this.renderReviewItems(); checkout.updateTotals(); document.getElementById('orderReviewModal').classList.add('show'); }, closeOrderReview: function () { document.getElementById('orderReviewModal').classList.remove('show'); }, renderReviewItems: function () { const container = document.getElementById('orderReviewItems'); if (!container) return; container.innerHTML = ''; const items = CardapioCart.items; items.forEach(item => { container.innerHTML += ` <div class="order-review-item"> <div class="order-review-item-qty">${item.quantity}x</div> <div class="order-review-item-info"> <div class="order-review-item-name">${item.name}</div> ${item.isCombo && item.products ? ` <div class="order-review-combo-details" style="font-size: 0.85rem; color: #666; margin-top: 2px;"> ${item.products.map(p => ` <div> <span>‚Ä¢ ${p.name}</span> ${p.additionals && p.additionals.length > 0 ? ` <span style="font-size: 0.8rem; color: #888;">(+ ${p.additionals.map(a => a.name).join(', ')})</span> ` : ''} </div> `).join('')} </div> ` : ''} ${!item.isCombo && item.additionals && item.additionals.length > 0 ? `<div class="order-review-item-extras">+ ${item.additionals.map(a => a.name).join(', ')}</div>` : ''} ${item.observation ? `<div class="order-review-item-obs">Obs: ${item.observation}</div>` : ''} </div> <div class="order-review-item-actions"> <span class="order-review-item-price">${Utils.formatCurrency(item.unitPrice * item.quantity)}</span> <button class="order-review-remove-btn" onclick="CardapioCart.remove(${item.id}); CheckoutModals.renderReviewItems(); CardapioCheckout.updateTotals(); if(CardapioCart.items.length === 0) CheckoutModals.closeOrderReview();"> <i data-lucide="trash-2" size="16"></i> </button> </div> </div> `; }); Utils.initIcons(); }, goToPayment: function (checkout) { this.closeOrderReview(); checkout.updateTotals(); const changeContainer = document.getElementById('changeContainer'); if (changeContainer) { changeContainer.style.display = 'none'; } checkout.selectedPaymentMethod = null; document.querySelectorAll('input[name="paymentMethod"]').forEach(r => r.checked = false); document.getElementById('paymentModal').classList.remove('has-change'); const changeInput = document.getElementById('changeAmount'); if (changeInput) { changeInput.value = ''; changeInput.oninput = function () { Utils.formatMoneyInput(this); }; } document.getElementById('paymentModal').classList.add('show'); CheckoutFields.updateFieldsVisibility(checkout.selectedOrderType); }, closePayment: function () { document.getElementById('paymentModal').classList.remove('show'); }, backToReview: function (checkout) { this.closePayment(); this.openOrderReview(checkout); }, selectPaymentMethod: function (checkout, method) { checkout.selectedPaymentMethod = method; const changeContainer = document.getElementById('changeContainer'); if (method === 'dinheiro') { changeContainer.style.display = 'block'; document.getElementById('paymentModal').classList.add('has-change'); setTimeout(() => CheckoutFields.scrollToChange(), 250); } else { changeContainer.style.display = 'none'; document.getElementById('paymentModal').classList.remove('has-change'); checkout.hasNoChange = false; } } }; window.CheckoutModals = CheckoutModals; const CardapioCheckout = { selectedOrderType: 'entrega', selectedPaymentMethod: null, hasNoNumber: false, hasNoChange: false, init: function () { const phoneInput = document.getElementById('customerPhone'); if (phoneInput) { phoneInput.oninput = function () { Utils.formatPhone(this); }; } const modal = document.getElementById('paymentModal'); if (modal) { modal.addEventListener('click', (e) => { if (e.target === modal) this.closePayment(); }); } setTimeout(() => { const currentRadio = document.querySelector(`input[name="orderType"][value="${this.selectedOrderType}"]`); if (!currentRadio || currentRadio.disabled) { const enabledRadio = document.querySelector('input[name="orderType"]:not([disabled])'); if (enabledRadio) { this.setOrderType(enabledRadio.value); } } }, 100); }, getDeliveryFee: function () { if (this.selectedOrderType !== 'entrega') return 0; const config = window.cardapioConfig || {}; return parseFloat(config.delivery_fee || 0); }, getFinalTotal: function () { const cartTotal = CardapioCart.getTotals().value; return cartTotal + this.getDeliveryFee(); }, updateTotals: function () { const fee = this.getDeliveryFee(); const total = this.getFinalTotal(); const feeRow = document.getElementById('deliveryFeeRow'); if (feeRow) { if (this.selectedOrderType === 'entrega' && fee > 0) { feeRow.style.display = 'flex'; const elDiv = document.getElementById('deliveryFeeValue'); if (elDiv) elDiv.innerText = Utils.formatCurrency(fee); } else { feeRow.style.display = 'none'; } } const totalFormatted = Utils.formatCurrency(total); const reviewTotal = document.getElementById('orderReviewTotal'); if (reviewTotal) reviewTotal.innerText = totalFormatted; const paymentTotal = document.getElementById('paymentTotalValue'); if (paymentTotal) paymentTotal.innerText = totalFormatted; }, setOrderType: function (type) { this.selectedOrderType = type; document.querySelectorAll('input[name="orderType"]').forEach(radio => { radio.checked = (radio.value === type); }); this.updateFieldsVisibility(); this.updateTotals(); }, updateFieldsVisibility: function () { CheckoutFields.updateFieldsVisibility(this.selectedOrderType); }, toggleNoNumber: function () { CheckoutFields.toggleNoNumber(this); }, toggleNoChange: function () { CheckoutFields.toggleNoChange(this); }, confirmChange: function () { CheckoutFields.confirmChange(); }, editChange: function () { CheckoutFields.editChange(this); }, scrollToChange: function () { CheckoutFields.scrollToChange(); }, openOrderReview: function () { CheckoutModals.openOrderReview(this); }, closeOrderReview: function () { CheckoutModals.closeOrderReview(); }, renderReviewItems: function () { CheckoutModals.renderReviewItems(); this.updateTotals(); }, goToPayment: function () { CheckoutModals.goToPayment(this); }, closePayment: function () { CheckoutModals.closePayment(); }, backToReview: function () { CheckoutModals.backToReview(this); }, selectPaymentMethod: function (method) { CheckoutModals.selectPaymentMethod(this, method); }, sendOrder: async function () { await CheckoutOrder.send(this); }, reset: function () { CardapioCart.clear(); this.selectedPaymentMethod = null; this.selectedOrderType = 'entrega'; this.hasNoNumber = false; document.getElementById('paymentModal').classList.remove('show'); document.querySelectorAll('input').forEach(i => i.value = ''); document.getElementById('changeContainer').style.display = 'none'; document.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false); this.setOrderType('entrega'); } }; window.CardapioCheckout = CardapioCheckout; try { Object.defineProperty(window, 'selectedOrderType', { get: () => CardapioCheckout.selectedOrderType, set: (val) => CardapioCheckout.selectedOrderType = val, configurable: true }); Object.defineProperty(window, 'selectedPaymentMethod', { get: () => CardapioCheckout.selectedPaymentMethod, set: (val) => CardapioCheckout.selectedPaymentMethod = val, configurable: true }); Object.defineProperty(window, 'hasNoNumber', { get: () => CardapioCheckout.hasNoNumber, set: (val) => CardapioCheckout.hasNoNumber = val, configurable: true }); } catch (e) { console.warn('[CardapioCheckout] Falha ao definir getters globais:', e); } document.addEventListener('change', function (e) { if (e.target.name === 'paymentMethod') { CardapioCheckout.selectPaymentMethod(e.target.value); } }); (function () { 'use strict'; function debounce(fn, wait) { let t = null; return function () { const args = arguments; const ctx = this; clearTimeout(t); t = setTimeout(() => fn.apply(ctx, args), wait); }; } const CardapioManager = { init: function () { this.initModules(); this.bindEvents(); this.recoverCart(); this.initIcons(); }, initModules: function () { if (window.CardapioModals && CardapioModals.init) CardapioModals.init(); if (window.CardapioCheckout && CardapioCheckout.init) CardapioCheckout.init(); }, recoverCart: function () { if (window.CardapioCart) CardapioCart.updateUI(); }, initIcons: function () { if (typeof lucide !== 'undefined') lucide.createIcons(); }, bindEvents: function () { this.ui.bindViewportAdjustments(); const searchInput = document.getElementById('cardapioSearchInput'); if (searchInput) { this.ui.cacheNodes(); const ui = this.ui; searchInput.addEventListener('input', debounce((e) => ui.handleSearch(e), 180)); } this.ui.bindCategoryFilters(); this.ui.bindAddButtons(); }, ui: { bindViewportAdjustments: function () { if (window.visualViewport && typeof window.onVV === 'function') { window.visualViewport.addEventListener('resize', window.onVV); window.visualViewport.addEventListener('scroll', window.onVV); } if (typeof window.adjustPaddingForKeyboard === 'function' && typeof window.ensureVisible === 'function') { document.querySelectorAll('input, textarea').forEach(input => { input.addEventListener('focus', () => { window.adjustPaddingForKeyboard(true); window.ensureVisible(input); }); input.addEventListener('blur', () => { window.adjustPaddingForKeyboard(false); }); }); } }, cacheNodes: function () { try { this._products = Array.from(document.querySelectorAll('.cardapio-product-card')); this._categories = Array.from(document.querySelectorAll('.cardapio-category-section')); } catch (err) { this._products = []; this._categories = []; } }, handleSearch: function (e) { const term = (e.target.value || '').toLowerCase().trim(); const products = this._products || Array.from(document.querySelectorAll('.cardapio-product-card')); const categories = this._categories || Array.from(document.querySelectorAll('.cardapio-category-section')); products.forEach(product => { let name = product.dataset.productName; let desc = product.dataset.productDescription; if (typeof name === 'undefined') name = (product.getAttribute('data-product-name') || ''); if (typeof desc === 'undefined') desc = (product.getAttribute('data-product-description') || ''); const hay = (name + ' ' + desc).toLowerCase(); const visible = term === '' || hay.indexOf(term) !== -1; product.style.display = visible ? 'flex' : 'none'; }); categories.forEach(category => { const children = Array.from(category.querySelectorAll('.cardapio-product-card')); const hasVisible = children.some(c => c.style.display !== 'none'); category.style.display = (hasVisible || term === '') ? 'block' : 'none'; }); }, bindCategoryFilters: function () { document.querySelectorAll('.cardapio-category-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); this.filterByCategory(btn.getAttribute('data-category')); }); }); const container = document.querySelector('.cardapio-categories'); if (container) { container.addEventListener('click', (e) => { const btn = e.target.closest('.cardapio-category-btn'); if (btn) { e.preventDefault(); this.filterByCategory(btn.getAttribute('data-category')); } }); } }, filterByCategory: function (categoryName) { const sections = document.querySelectorAll('.cardapio-category-section'); const buttons = document.querySelectorAll('.cardapio-category-btn'); buttons.forEach(btn => { const isActive = btn.getAttribute('data-category') === categoryName; btn.classList.toggle('active', isActive); }); sections.forEach(sec => { const secId = sec.getAttribute('data-category-id'); const isVisible = categoryName === 'todos' || secId === categoryName; sec.style.display = isVisible ? 'block' : 'none'; }); const searchInput = document.getElementById('cardapioSearchInput'); if (searchInput) { searchInput.value = ''; document.querySelectorAll('.cardapio-product-card').forEach(p => p.style.display = 'flex'); } }, bindAddButtons: function () { document.querySelectorAll('.cardapio-add-btn').forEach(btn => { btn.addEventListener('click', function (e) { e.stopPropagation(); // Evita clique no card pai const card = this.closest('.cardapio-product-card'); if (card) { const productId = card.getAttribute('data-product-id'); const comboId = card.getAttribute('data-combo-id'); if (productId) { if (window.CardapioModals) CardapioModals.openProduct(productId); else if (window.openProductModal) window.openProductModal(productId); } else if (comboId) { if (window.CardapioModals && CardapioModals.openCombo) CardapioModals.openCombo(comboId); } } }); }); } } }; window.CardapioManager = CardapioManager; window.filterByCategory = (cat) => CardapioManager.ui.filterByCategory(cat); document.addEventListener('DOMContentLoaded', () => CardapioManager.init()); })();